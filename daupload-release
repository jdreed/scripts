#!/bin/sh
set -e

# Usage: daupload-release [-A] [-S] CHANGESFILE
#        daupload-beta [-A] [-S] CHANGESFILE

# After a package has been built for all Debian/Ubuntu versions and
# platforms (typically using "da sbuildhack DSCFILE"), this script
# uploads the package into the release or beta apt repository.  If -A
# is specified, only one architecture per Debian/Ubuntu version is
# uploaded.  If -S is specified, only the source package is uploaded.

# Upon completion, moves all of the generated files into the "built"
# subdirectory.

: ${DEBATHENA_APT=/mit/debathena/apt}
source $(dirname "$0")/debian-versions.sh

case "$(basename "$0")" in
    daupload-release)
	repo=$DEBATHENA_APT
	;;
    daupload-beta)
	repo=${DEBATHENA_APT}-beta
	;;
    *)
	echo "Unknown repo." >&2
	exit 1
	;;
esac

v () {
    echo "$@"
    "$@"
}

A=0
if [ "$1" = "-A" ]; then A=1; shift; fi
S=0
if [ "$1" = "-S" ]; then S=1; shift; fi

change=$1
cd "$(dirname "$change")"
change=$(basename "$change")
base=${change%_source.changes}

check () {
    [ -s "$1" ] || missing="$missing$1 "
}
uncheck () {
    ! [ -s "$1" ] || missing="$missing-$1 "
}

missing=
[ -s "$change" ]
if [ $S -ne 1 ]; then
    for code in $DEBIAN_CODES; do
	if [ "$code" = "sarge" ]; then
	    check "$base~debian3.1_i386.changes"
	else
	    tag=$(gettag "$code")
	    check "${base}${tag}_amd64.changes"
	fi
    done
    if [ $A -eq 1 ]; then
	for code in $DEBIAN_CODES; do
	    if [ "$code" = "sarge" ]; then
		true;
	    else
		tag=$(gettag "$code")
		uncheck "${base}${tag}_i386.changes"
	    fi
	done
    else
	for code in $DEBIAN_CODES; do
	    if [ "$code" = "sarge" ]; then
		true;
	    else
		tag=$(gettag "$code")
		check "${base}${tag}_i386.changes"
	    fi
	done
    fi
fi

if [ -n "$missing" ]; then
    echo "Missing $missing" >&2
    echo -n "Continue? [y/N]"
    read a
    [ "$a" = "y" ]
fi

REPREPRO="v reprepro -Vb $repo"
REPREPROI="$REPREPRO --ignore=wrongdistribution"

for code in $DEBIAN_CODES; do
    $REPREPROI include "$code" "$change"
done

if [ $S -ne 1 ]; then
    for code in $DEBIAN_CODES; do
	if [ "$code" = "sarge" ]; then
	    $REPREPRO include sarge "$base~debian3.1_i386.changes"
	else
	    tag=$(gettag "$code")
	    [ $A -eq 1 ] || $REPREPRO include "$code" "${base}${tag}_i386.changes"
	    $REPREPRO include "$code" "${base}${tag}_amd64.changes"
	fi
    done
fi

changes=$change
for code in $$DEBIAN_CODES; do
    if [ "$code" = "sarge" ]; then
	changes=$changes\ $base~debian3.1_i386.changes
    else
	tag=$(gettag "$code")
	[ $A -eq 1 ] || changes=$changes\ "${base}${tag}"_i386.changes
	changes=$changes\ "${base}${tag}"_amd64.changes
    fi
done

files=${change%.changes}.build\ $changes
origfiles=
for change in $changes; do
    files=$files\ $(perl -0ne '$_ =~ /\nFiles: *\n(( [^\n]*\n)*)/; print $1;' "$change" | awk '{print $5}' | grep -v '\.orig\.tar\.gz$' || :)
    origfiles=$origfiles\ $(perl -0ne '$_ =~ /\nFiles: *\n(( [^\n]*\n)*)/; print $1;' "$change" | awk '{print $5}' | grep '\.orig\.tar\.gz$' || :)
done

built=built/
[ -d "$built" ] || mkdir "$built"
mv -i $files "$built"
if [ -n "$origfiles" ]; then
    for orig in $origfiles; do
        [ -e "$built/$orig" ] || cp -ai "$orig" "$built/"
    done
fi
